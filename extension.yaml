# Learn detailed information about the fields of an extension.yaml file in the docs:
# https://firebase.google.com/docs/extensions/reference/extension-yaml

# Identifier for your extension
# TODO: Replace this with an descriptive name for your extension.
name: firestore-to-mongodb  
version: 0.0.1  # Follow semver versioning
specVersion: v1beta  # Version of the Firebase Extensions specification

# Friendly display name for your extension (~3-5 words)
displayName: Sync data from Firestore to MongoDB

# Brief description of the task your extension performs (~1 sentence)
description: >-
  This extension syncs a Firestore collection to a MongoDB database. It triggers on all write events (create, update, delete) in the Firestore collection and reflects those changes in the MongoDB collection. Perfect for syncing up to Firestore Enterprise.

author:
  authorName: Jamie Curnow
  url: https://github.com/JamieCurnow

license: apache-2.0  # https://spdx.org/licenses/

# Public URL for the source code of your extension.
# TODO:  Replace this with your GitHub repo.
sourceUrl: https://github.com/JamieCurnow/firebase-extension-firestore-to-mongodb

# Specify whether a paid-tier billing plan is required to use your extension.
# Learn more in the docs: https://firebase.google.com/docs/extensions/reference/extension-yaml#billing-required-field
billingRequired: true

# In an `apis` field, list any Google APIs (like Cloud Translation, BigQuery, etc.)
# required for your extension to operate.
# Learn more in the docs:
# https://firebase.google.com/docs/extensions/reference/extension-yaml#apis-field

# In a `roles` field, list any IAM access roles required for your extension to operate.
# Learn more in the docs:
# https://firebase.google.com/docs/extensions/reference/extension-yaml#roles-field

# In the `resources` field, list each of your extension's functions, including the trigger for each function.
# Learn more in the docs:
# https://firebase.google.com/docs/extensions/reference/extension-yaml#resources-field
resources:
  - name: syncToMongo
    type: firebaseextensions.v1beta.function
    description: >-
      A function that triggers on Firestore writes and syncs the data to MongoDB.
    properties:
      runtime: nodejs22
      eventTrigger:
        eventType: google.cloud.firestore.document.v1.written
        resource: projects/${PROJECT_ID}/databases/(default)/documents/${param:FIRESTORE_COLLECTION_PATH}/{docId}

# In the `params` field, set up your extension's user-configured parameters.
# Learn more in the docs:
# https://firebase.google.com/docs/extensions/reference/extension-yaml#params-field
params:
  - param: MONGODB_CONNECTION_STRING
    label: MongoDB Connection String
    description: The connection string for your MongoDB database.
    type: secret
    required: true
    validationRegex: ^mongodb(\+srv)?:\/\/.+
    validationErrorMessage: The connection string must be a valid MongoDB connection string.
  - param: MONGODB_DATABASE_NAME
    label: MongoDB Database Name
    description: The name of the database to sync to.
    type: string
    required: true
  - param: MONGODB_COLLECTION_NAME
    label: MongoDB Collection Name
    description: The name of the collection to sync to.
    type: string
    required: true
  - param: FIRESTORE_COLLECTION_PATH
    label: Firestore Collection Path
    description: The path to the Firestore collection to sync from.
    type: string
    required: true
  - param: FIRESTORE_DOC_ID_FIELD
    label: Firestore Document ID Field
    description: The name of the field in MongoDB to store the Firestore document ID.
    type: string
    default: __firestore_doc_id
    required: false

roles:
  - role: datastore.user
    reason: Allows the extension to access Firestore.
  - role: secretmanager.secretAccessor
    reason: Allows the extension to access the MongoDB connection string secret.

apis:
  - apiName: secretmanager.googleapis.com
    reason: Allows the extension to access secrets.
